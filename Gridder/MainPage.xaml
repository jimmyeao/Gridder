<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:Gridder.ViewModels"
             xmlns:models="clr-namespace:Gridder.Models"
             xmlns:converters="clr-namespace:Gridder.Converters"
             xmlns:views="clr-namespace:Gridder.Views"
             x:Class="Gridder.MainPage"
             x:DataType="vm:MainViewModel"
             Title="Gridder - Beat Grid Analyzer">

    <ContentPage.Resources>
        <converters:AnalysisStatusToColorConverter x:Key="StatusToColor" />
        <converters:AnalysisStatusToTextConverter x:Key="StatusToText" />
        <converters:NullToBoolConverter x:Key="NotNullToBool" />
        <converters:NullToBoolConverter x:Key="NullToBool" Invert="True" />
        <converters:BoolToPlayPauseConverter x:Key="BoolToPlayPause" />
    </ContentPage.Resources>

    <Grid ColumnDefinitions="350,*" RowDefinitions="*,Auto"
          BackgroundColor="#0d0d0d">

        <!-- Left Panel: Library Browser -->
        <Grid Grid.Column="0" Grid.Row="0"
              RowDefinitions="Auto,Auto,Auto,*"
              BackgroundColor="#141418"
              Padding="8">

            <!-- Folder Picker -->
            <Button Grid.Row="0"
                    Text="Browse Music Folder"
                    Command="{Binding BrowseFolderCommand}"
                    BackgroundColor="#1e1e2e"
                    TextColor="#00d4ff"
                    FontAttributes="Bold"
                    Margin="0,0,0,8" />

            <!-- Action Buttons -->
            <Grid Grid.Row="1" ColumnDefinitions="*,*" RowDefinitions="Auto,Auto" ColumnSpacing="4" RowSpacing="4"
                  Margin="0,0,0,4">
                <Button Grid.Column="0" Grid.Row="0"
                        Text="Analyze"
                        Command="{Binding AnalyzeSelectedTrackCommand}"
                        BackgroundColor="#1e1e2e" TextColor="#ff8800"
                        FontSize="12" FontAttributes="Bold" Padding="4" />
                <Button Grid.Column="1" Grid.Row="0"
                        Text="Load Grid"
                        Command="{Binding LoadExistingBeatGridCommand}"
                        BackgroundColor="#1e1e2e" TextColor="#aaaaaa"
                        FontSize="12" Padding="4" />
                <Button Grid.Column="0" Grid.Row="1"
                        Text="Save to File"
                        Command="{Binding SaveBeatGridCommand}"
                        BackgroundColor="#1e1e2e" TextColor="#00ff88"
                        FontSize="12" FontAttributes="Bold" Padding="4" />
                <Button Grid.Column="1" Grid.Row="1"
                        Text="Export JSON"
                        Command="{Binding ExportJsonCommand}"
                        BackgroundColor="#1e1e2e" TextColor="#aaaaaa"
                        FontSize="12" Padding="4" />
            </Grid>

            <!-- Library Path Display -->
            <Label Grid.Row="2"
                   Text="{Binding LibraryPath, StringFormat='Path: {0}', TargetNullValue='No folder selected'}"
                   TextColor="#888888"
                   FontSize="11"
                   LineBreakMode="TailTruncation"
                   Margin="0,0,0,8" />

            <!-- Track List -->
            <CollectionView Grid.Row="3"
                            ItemsSource="{Binding Tracks}"
                            SelectedItem="{Binding SelectedTrack, Mode=TwoWay}"
                            SelectionMode="Single">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:AudioTrack">
                        <Border StrokeThickness="0"
                                BackgroundColor="Transparent"
                                Padding="8,6">
                            <VisualStateManager.VisualStateGroups>
                                <VisualStateGroup Name="CommonStates">
                                    <VisualState Name="Normal" />
                                    <VisualState Name="Selected">
                                        <VisualState.Setters>
                                            <Setter Property="BackgroundColor" Value="#1a2a3a" />
                                        </VisualState.Setters>
                                    </VisualState>
                                </VisualStateGroup>
                            </VisualStateManager.VisualStateGroups>

                            <Grid ColumnDefinitions="Auto,*,Auto" RowDefinitions="Auto,Auto">
                                <!-- Status indicator -->
                                <BoxView Grid.RowSpan="2"
                                         WidthRequest="4"
                                         CornerRadius="2"
                                         Color="{Binding AnalysisStatus, Converter={StaticResource StatusToColor}}"
                                         VerticalOptions="Fill"
                                         Margin="0,0,8,0" />

                                <!-- Title -->
                                <Label Grid.Column="1" Grid.Row="0"
                                       Text="{Binding DisplayName}"
                                       TextColor="#e0e0e0"
                                       FontSize="13"
                                       FontAttributes="Bold"
                                       LineBreakMode="TailTruncation" />

                                <!-- Artist + Duration -->
                                <Label Grid.Column="1" Grid.Row="1"
                                       TextColor="#888888"
                                       FontSize="11"
                                       LineBreakMode="TailTruncation">
                                    <Label.Text>
                                        <MultiBinding StringFormat="{}{0} | {1}">
                                            <Binding Path="DisplayArtist" />
                                            <Binding Path="DurationDisplay" />
                                        </MultiBinding>
                                    </Label.Text>
                                </Label>

                                <!-- Format badge -->
                                <Border Grid.Column="2" Grid.RowSpan="2"
                                        BackgroundColor="#2a2a3a"
                                        StrokeThickness="0"
                                        Padding="6,2"
                                        VerticalOptions="Center">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="4" />
                                    </Border.StrokeShape>
                                    <Label Text="{Binding FileFormat}"
                                           TextColor="#00d4ff"
                                           FontSize="10"
                                           FontAttributes="Bold" />
                                </Border>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>

                <CollectionView.EmptyView>
                    <VerticalStackLayout VerticalOptions="Center"
                                         HorizontalOptions="Center"
                                         Padding="20">
                        <Label Text="No tracks loaded"
                               TextColor="#666666"
                               FontSize="16"
                               HorizontalTextAlignment="Center" />
                        <Label Text="Click 'Browse Music Folder' to get started"
                               TextColor="#444444"
                               FontSize="12"
                               HorizontalTextAlignment="Center"
                               Margin="0,8,0,0" />
                    </VerticalStackLayout>
                </CollectionView.EmptyView>
            </CollectionView>
        </Grid>

        <!-- Right Panel -->
        <Grid Grid.Column="1" Grid.Row="0"
              BackgroundColor="#0d0d0d">

            <!-- Placeholder when no track selected -->
            <VerticalStackLayout VerticalOptions="Center"
                                 HorizontalOptions="Center"
                                 IsVisible="{Binding SelectedTrack, Converter={StaticResource NullToBool}}">
                <Label Text="GRIDDER"
                       TextColor="#1a1a2e"
                       FontSize="72"
                       FontAttributes="Bold"
                       HorizontalTextAlignment="Center" />
                <Label Text="Select a track from the library to begin"
                       TextColor="#333333"
                       FontSize="16"
                       HorizontalTextAlignment="Center"
                       Margin="0,16,0,0" />
            </VerticalStackLayout>

            <!-- Track info + Waveform + Playback when track is selected -->
            <Grid RowDefinitions="Auto,*,Auto"
                  IsVisible="{Binding SelectedTrack, Converter={StaticResource NotNullToBool}}">

                <!-- Track header -->
                <Grid Grid.Row="0" Padding="16,8"
                      BackgroundColor="#141418"
                      ColumnDefinitions="*,Auto">
                    <VerticalStackLayout Grid.Column="0">
                        <Label Text="{Binding SelectedTrack.DisplayName}"
                               TextColor="#e0e0e0"
                               FontSize="18"
                               FontAttributes="Bold" />
                        <Label TextColor="#888888" FontSize="12">
                            <Label.Text>
                                <MultiBinding StringFormat="{}{0} | {1} | {2}">
                                    <Binding Path="SelectedTrack.DisplayArtist" />
                                    <Binding Path="SelectedTrack.DurationDisplay" />
                                    <Binding Path="SelectedTrack.FileFormat" />
                                </MultiBinding>
                            </Label.Text>
                        </Label>
                    </VerticalStackLayout>

                    <HorizontalStackLayout Grid.Column="1" Spacing="8" VerticalOptions="Center">
                        <ActivityIndicator IsRunning="{Binding IsAnalyzing}"
                                           IsVisible="{Binding IsAnalyzing}"
                                           Color="#00d4ff"
                                           WidthRequest="20" HeightRequest="20" />
                        <Label Text="{Binding SelectedTrack.AnalysisStatus, Converter={StaticResource StatusToText}}"
                               TextColor="{Binding SelectedTrack.AnalysisStatus, Converter={StaticResource StatusToColor}}"
                               FontSize="12"
                               VerticalTextAlignment="Center" />
                    </HorizontalStackLayout>
                </Grid>

                <!-- Waveform Editor -->
                <views:WaveformEditorView Grid.Row="1"
                                           BindingContext="{Binding WaveformEditor}" />

                <!-- Playback Controls -->
                <Grid Grid.Row="2"
                      BackgroundColor="#141418"
                      Padding="12,6"
                      ColumnDefinitions="Auto,Auto,Auto,Auto,Auto,*,Auto,Auto"
                      BindingContext="{Binding Playback}"
                      x:DataType="vm:PlaybackViewModel">

                    <!-- Transport buttons -->
                    <Button Grid.Column="0" Text="&lt;&lt;"
                            Command="{Binding SkipBackCommand}"
                            BackgroundColor="#1e1e2e" TextColor="#e0e0e0"
                            WidthRequest="40" HeightRequest="34"
                            FontSize="12" Padding="0" />
                    <Button Grid.Column="1"
                            Text="{Binding IsPlaying, Converter={StaticResource BoolToPlayPause}}"
                            Command="{Binding PlayPauseCommand}"
                            BackgroundColor="#1e1e2e" TextColor="#00d4ff"
                            WidthRequest="50" HeightRequest="34"
                            FontSize="14" FontAttributes="Bold" Padding="0"
                            x:Name="PlayPauseBtn" />
                    <Button Grid.Column="2" Text="Stop"
                            Command="{Binding StopCommand}"
                            BackgroundColor="#1e1e2e" TextColor="#e0e0e0"
                            WidthRequest="44" HeightRequest="34"
                            FontSize="11" Padding="0" />
                    <Button Grid.Column="3" Text="&gt;&gt;"
                            Command="{Binding SkipForwardCommand}"
                            BackgroundColor="#1e1e2e" TextColor="#e0e0e0"
                            WidthRequest="40" HeightRequest="34"
                            FontSize="12" Padding="0" />

                    <!-- Position display -->
                    <Label Grid.Column="4"
                           Text="{Binding PositionDisplay}"
                           TextColor="#00d4ff"
                           FontSize="16"
                           FontAttributes="Bold"
                           VerticalTextAlignment="Center"
                           Margin="12,0" />

                    <!-- Spacer -->

                    <!-- Metronome toggle -->
                    <Label Grid.Column="6"
                           Text="Click"
                           TextColor="#888888"
                           FontSize="11"
                           VerticalTextAlignment="Center"
                           Margin="0,0,4,0" />
                    <Switch Grid.Column="7"
                            IsToggled="{Binding IsMetronomeEnabled}"
                            OnColor="#00d4ff"
                            ThumbColor="#e0e0e0" />
                </Grid>
            </Grid>
        </Grid>

        <!-- Status Bar -->
        <Grid Grid.Column="0" Grid.ColumnSpan="2" Grid.Row="1"
              BackgroundColor="#0a0a12"
              Padding="12,6"
              ColumnDefinitions="*,Auto,Auto,Auto">

            <Label Grid.Column="0"
                   Text="{Binding StatusMessage}"
                   TextColor="#888888"
                   FontSize="11"
                   VerticalTextAlignment="Center" />

            <Label Grid.Column="1"
                   Text="{Binding TrackCount, StringFormat='Tracks: {0}'}"
                   TextColor="#666666"
                   FontSize="11"
                   VerticalTextAlignment="Center"
                   Margin="16,0" />

            <Label Grid.Column="2"
                   Text="{Binding WithBeatGridCount, StringFormat='With Grid: {0}'}"
                   TextColor="#666666"
                   FontSize="11"
                   VerticalTextAlignment="Center"
                   Margin="16,0" />

            <Label Grid.Column="3"
                   Text="{Binding AnalyzedCount, StringFormat='Analyzed: {0}'}"
                   TextColor="#666666"
                   FontSize="11"
                   VerticalTextAlignment="Center"
                   Margin="16,0" />
        </Grid>
    </Grid>

</ContentPage>
